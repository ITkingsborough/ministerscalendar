<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingsborough Church Calendar</title>
    
    <!-- Import iCal.js for parsing ICS files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            min-height: 100vh;
        }
        .ps-note {
            font-weight: bold;
            text-align: center;
            padding: 10px;
            background-color: #ffeb3b;
            color: #333;
            border-radius: 5px;
            margin: 0 auto 20px auto;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .header {
            max-width: 800px;
            margin: 0 auto 30px auto;
            text-align: center;
            padding: 40px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: linear-gradient(to right, #3498db, #2980b9);
        }
        .header h1 {
            color: white;
            font-size: 32px;
            margin: 0;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        .duty-headline {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #d63031;
            margin-bottom: 20px;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="ps-note">
        <strong>PS:</strong> All ministers are required to put on a clergy collar on their officiating days.
    </div>
    
    <div class="header">
        <h1>Kingsborough Church Officiating Calendar</h1>
    </div>
    
    <div class="duty-headline">
        <h2 id="on-duty">Loading...</h2>
    </div>

    <script>
        const ministerSchedules = [
            { name: "Pastor Bodinga Sambo", file: "attached_assets/PBO.ics" },
            { name: "Pastor Christine", file: "attached_assets/PC.ics" },
            { name: "Pastor Emmanuel", file: "attached_assets/PE.ics" },
            { name: "Pastor Gbenga Jola", file: "attached_assets/PGJO.ics" },
            { name: "Pastor Segun Oyinloye", file: "attached_assets/PSO.ics" },
            { name: "Elder Moji Hassan", file: "attached_assets/EMH.ics" },
            { name: "Minister Eniola Shabi", file: "attached_assets/MES.ics" },
            { name: "Minister Joshua Shoyebo", file: "attached_assets/MJA.ics" },
            { name: "Minister Joash Balogun", file: "attached_assets/MJB.ics" },
            { name: "Minister Nonye Balogun", file: "attached_assets/MNB.ics" },
            { name: "Minister Peter Abdulaziz", file: "attached_assets/MPA.ics" },
            { name: "Minister Tomi Kaka", file: "attached_assets/MSTK.ics" },
            { name: "Minister Wale Famurewa", file: "attached_assets/MWF.ics" },
            { name: "Minister Yomi Okanlawon", file: "attached_assets/MYO.ics" }
        ];

        function getWeekNumber(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDays = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
            return Math.ceil((pastDays + startOfYear.getDay() + 1) / 7);
        }

        async function fetchAndParseICS(url, ministerName) {
            try {
                const response = await fetch(url);
                const icsText = await response.text();
                const jcalData = ICAL.parse(icsText);
                const comp = new ICAL.Component(jcalData);
                const events = comp.getAllSubcomponents("vevent");

                return events.map(event => {
                    const startDate = new ICAL.Time.fromString(event.getFirstPropertyValue("dtstart"));
                    return { name: ministerName, date: new Date(startDate.toJSDate()) };
                });
            } catch (error) {
                console.error(`Error loading ICS for ${ministerName}:`, error);
                return [];
            }
        }

        async function updateDutyPersons() {
            const currentWeek = getWeekNumber(new Date());
            let dutyMinisters = [];

            for (const minister of ministerSchedules) {
                const events = await fetchAndParseICS(minister.file, minister.name);
                events.forEach(event => {
                    if (getWeekNumber(event.date) === currentWeek) {
                        dutyMinisters.push({ name: event.name, file: minister.file });
                    }
                });
            }

            const onDutyElement = document.getElementById("on-duty");
            if (dutyMinisters.length > 0) {
                onDutyElement.innerHTML = `
                    This week's officiating ministers:<br>
                    ${dutyMinisters.map(m => `<strong>${m.name}</strong> <a href="${m.file}" class="download-btn" download>Download</a>`).join("<br>")}
                `;
            } else {
                onDutyElement.innerHTML = "No ministers assigned this week.";
            }
        }

        updateDutyPersons();
    </script>
</body>
</html>

